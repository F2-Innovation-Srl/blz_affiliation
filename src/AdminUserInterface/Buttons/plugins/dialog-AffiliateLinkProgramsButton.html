<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Inserisci il link</title>
    <script type="text/javascript" src="/wp/wp-includes/js/tinymce/tiny_mce_popup.js"></script>
    
    <script>

        /// dati iniettati dal controller
        var subjects  = {{subjects}};
        var programs  = {{programs}};
        var is_stored = {{is_stored}};

        /** 
         * Per gestire i campi
         */
        function FieldsManager() { 
            
            this.subject      = document.getElementById('subject');
            this.program      = document.getElementById('program');
            this.link         = document.getElementById('link');
            this.tracking_id  = document.getElementById('tracking_id');
            this.content      = document.getElementById('content');            
            this.submit       = document.getElementById('submit');
            this.ga_event     = document.getElementById('ga_event');  

            if(is_stored)
                /// rende visibile la text input
                [].forEach.call( document.querySelectorAll('.ga_event'), function( item ) {
                    item.classList.remove('ga_event'); 
                });                    
            
            this.content.value = tinymce.activeEditor.selection.getContent();
            
            this.submit.addEventListener('click', function(e) {

                var subject     = `subject="${this.subject.value}"`;
                var program     = `program="${this.program.value}"`;
                var tracking_id = `tracking_id="${this.tracking_id.value}"`;
                var link        = `link="${this.link.value}"`;
                var content     = this.content.value;
                var ga_event    = (is_stored) ? `ga_event="${this.ga_event.value}"` : '';


                if (link            == '') { alert("Inserire un link");         return; }
                if (content.trim()  == '') { alert("Inserire un testo");        return; }
                if (subject         == '') { alert("Selezionare un subject");   return; }
                if (program         == '') { alert("Selezionare un programma"); return; }
                
                this.shortcode = `[affiliate_program_link ${link} ${ga_event} ${tracking_id} ${subject} ${program}]${content}[/affiliate_program_link]`;
                
                tinyMCE.activeEditor.execCommand( 'mceInsertContent', 0, this.shortcode );
                
                tinyMCEPopup.close();

            }.bind(this));
        }

        window.addEventListener('DOMContentLoaded', function() { 
            
            new FieldsManager();

        }.bind(this));

    </script>

    <style>
        body { padding: 10px; background-color: #eee;}
        
        input, select { 
            width: 90%; 
            padding: 4px ;
            font-size:13px;
            border-radius: 5px;
            margin-left: 5%;
        }

        legend {margin: 10px 0 2px 5%; font-size:13px; }

        #submit {
            width: 300px;
            background-color: lightblue;
            margin:20px auto;         
            display: block;   
        }
        .ga_event { display: none;}
    </style>    
</head>
<body onload="tinyMCEPopup.executeOnLoad('init();')">
    
    <legend>Inserisci il link</legend>
    <input type="text" id="link" name="link" value=""/>

    <legend>Inserisci il testo</legend>
    <input type="text" id="content" name="content" value=""/>

    <legend>Seleziona il subject</legend>
                        
    <select name="subject" id="subject">
        <option value="">-- scegli --</option>        
    </select>
    <script>
        var subject_select = document.getElementById('subject');
        subjects.forEach( function(item) { 
            subject_select.insertAdjacentHTML('beforeend', `<option value="${item.slug}">${item.name}</option>`); 
        });   
        subject_select.addEventListener('change', function() {
            var program_select = document.getElementById('program');
            //remove previus elements
            program_select.remove();
            program_select.insertAdjacentHTML('beforeend', `<option value="">-- scegli --</option>`);
                
            //put new elements
            programs.forEach( function(item) { 
                if (item.parent_slug == subject_select.value){
                    program_select.insertAdjacentHTML('beforeend', `<option value="${item.slug}">${item.name}</option>`); 
                }
                
            }); 
        });   
    </script>

    <legend>Seleziona il programma</legend>
                            
    <select name="program" id="program">
        <option value="">-- scegli --</option>        
    </select>

    <legend>Inserisci il tracking_id</legend>
    <input type="text" id="tracking_id" name="tracking_id" value=""/>

    <legend class="ga_event">Inserisci il ga_event</legend>
    <input class="ga_event" type="text" id="ga_event" name="ga_event" value=""/>

    <input type="button" id="submit" value="Inserisci" />
</body>
</html>