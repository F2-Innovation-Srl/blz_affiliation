<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Inserisci il link</title>
    <script type="text/javascript" src="/wp/wp-includes/js/tinymce/tiny_mce_popup.js"></script>
    
    <script>

        /// dati iniettati dal controller
        var storedLinks = {{stored_links}};

        /** 
         * Per gestire i campi
         */
         function FieldsManager() { 
            
            this.link = document.getElementById('link');
        
            this.submit   = document.getElementById('submit');
    
            this.content = tinymce.activeEditor.selection.getContent();

            this.submit.addEventListener('click', function(e) {

                var link = this.link.value;
                
                
                if (link  == '') { alert("Selezionare un link");  return; }

                
                this.shortcode = `[affiliate_program_stored_link id=${link}]${this.content}[/affiliate_program_stored_link]`;
                
                tinyMCE.activeEditor.execCommand( 'mceInsertContent', 0, this.shortcode );
                
                tinyMCEPopup.close();

            }.bind(this));
        }


        window.addEventListener('DOMContentLoaded', function() {
            
            new FieldsManager();

        }.bind(this));

    </script>

    <style>
        body { padding: 10px; background-color: #eee;}
        
        input, select { 
            width: 90%; 
            padding: 4px ;
            font-size:13px;
            border-radius: 5px;
            margin-left: 5%;
        }

        legend {margin: 10px 0 2px 5%; font-size:13px; }

        #submit {
            width: 300px;
            background-color: lightblue;
            margin:20px auto;         
            display: block;   
        }
    </style>
    
    
</head>
<body onload="tinyMCEPopup.executeOnLoad('init();')">
    
    <legend>Seleziona il link</legend>
                        
    <select name="link" id="link">
        <option value="">-- scegli --</option>        
    </select>
    <script>
        var link_select = document.getElementById('link');        
        storedLinks.forEach( function(item) {                         
            link_select.insertAdjacentHTML('beforeend', `<option value="${item.id}">${item.title}</option>`); 
        });      
    </script>

    <input type="button" id="submit" value="Inserisci" />
    
</body>
</html>